# POTA CAT — Project Instructions

## What This Is
An Electron desktop app for hunting POTA (Parks on the Air) activators with a FlexRadio. It pulls live spots from the POTA API, displays them in a table or on a Leaflet map, and tunes the radio via SmartSDR CAT over TCP.

**Repo:** https://github.com/Waffleslop/POTA-CAT

## Tech Stack
- **Electron** (contextIsolation: true, nodeIntegration: false)
- **Leaflet.js** for the map (loaded via `<script>` tag, NOT require — renderer has no Node access)
- **serialport** for COM port CAT (also supports TCP sockets for SmartSDR)
- No framework — vanilla JS, plain CSS, single-page app

## File Structure
```
main.js              — Electron main process: window, IPC, spot fetching, CAT connection
preload.js           — contextBridge exposing window.api to renderer
renderer/
  index.html         — UI shell, CSP policy, Leaflet/CSS links
  app.js             — All renderer logic (table, map, filters, scan, settings)
  styles.css         — Dark theme styling
lib/
  pota.js            — POTA API client (https://api.pota.app/spot/activator)
  cat.js             — CatClient class: TCP + serial, auto-reconnect, FA/MD commands
  grid.js            — Maidenhead grid ↔ lat/lon, haversine distance
  bands.js           — Frequency → band mapping
assets/
  icon.svg           — Source icon (cat face with radio waves)
  icon.png           — 512x512 PNG (generated by scripts/build-icon.js)
  icon-256.png       — 256x256 PNG
scripts/
  build-icon.js      — SVG → PNG conversion using sharp
```

## Key Architecture Decisions
- **CSP is strict** — `default-src 'self'`, must allow `style-src 'unsafe-inline'` for Leaflet, `img-src` and `connect-src` for `*.tile.openstreetmap.org`
- **No require() in renderer** — Leaflet loaded via `<script>` tag, grid conversion duplicated in app.js as `gridToLatLonLocal()`
- **Spots sent after did-finish-load** — initial `refreshSpots()` fires in the `did-finish-load` handler so the renderer is ready to receive IPC
- **POTA API spotTime has no Z suffix** — must append 'Z' before parsing as Date to treat as UTC
- **Map world-wrapping** — markers plotted at -360, 0, +360 longitude offsets so they appear when scrolling past the antimeridian
- **Column widths** — stored as percentages in localStorage (`pota-cat-col-pct-v2`), 9 columns including Skip
- **Settings** — persisted to `settings.json` in Electron's userData folder

## Current Features
- Live POTA spot table with sortable columns and resizable column widths
- Leaflet map view with dark OSM tiles, home QTH marker, activator markers with popups
- Band/mode filters (both views)
- One-click tuning via SmartSDR CAT (TCP ports 5002-5005 for Slices A-D, or COM serial)
- QRZ callsign links (opens external browser)
- UTC clock in status bar
- Age column (relative time since spot, e.g. "5m", "1h 30m")
- Distance in miles or kilometers (setting)
- Watchlist — comma-separated callsigns in Settings, matched spots show a star emoji
- Scan — auto-tunes through filtered spots with configurable dwell time, skip/unskip per row
- electron-builder configured for Windows (.exe) and macOS (.dmg) packaging

## Settings (stored in settings.json)
- `grid` — Maidenhead grid square (default: FN20jb)
- `catTarget` — `{type, host, port}` or `{type, path}` for serial
- `distUnit` — 'mi' or 'km'
- `scanDwell` — seconds per frequency during scan (default: 7)
- `watchlist` — comma-separated callsign string

## Discussed But Not Built
- **Multi-slice S-meter monitoring** — tune 4-8 Flex slices to different spots simultaneously, show green indicator next to those with signal. Requires FlexLib TCP API (port 4992), not CAT. Significant new integration.
- **HamAlert Websocket integration** — real-time alerts from HamAlert API for watched callsigns spotted anywhere (not just POTA). Would need API key, persistent WS connection, merging alerts from second source.

## Dev Commands
```bash
npm start          # Run the app
npm run dist:win   # Build Windows installer
npm run dist:mac   # Build macOS dmg (must run on Mac)
npm run build-icon # Regenerate PNGs from SVG
```

## Style Conventions
- Dark theme: background #1a1a2e, header #16213e, accent red #e94560, blue links #4fc3f7
- The user prefers concise, functional UI — no unnecessary chrome
- Commit messages: short summary line, optional body, always include Co-Authored-By
